# ──────────────────────────────────────────────────────────────────────────────
# CI — Continuous Integration
#
# Runs on every push and pull request.  Three parallel jobs:
#   1. lint-and-typecheck  (ESLint + TypeScript)
#   2. test                (Vitest unit tests)
#   3. build               (Vite production build + Cloud Functions build)
#
# All three must pass before a PR can merge (configure in GitHub branch
# protection rules → require status checks).
# ──────────────────────────────────────────────────────────────────────────────

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  # ── Job 1: Lint + Typecheck ──────────────────────────────────────────────
  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: ESLint
        run: npm run lint

      - name: TypeScript (frontend)
        run: npm run typecheck

      - name: Install Cloud Functions dependencies
        run: npm ci
        working-directory: functions

      - name: TypeScript (Cloud Functions)
        run: npx tsc --noEmit
        working-directory: functions

  # ── Job 2: Tests ─────────────────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

  # ── Job 3: Build ─────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      # Frontend
      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_RECAPTCHA_SITE_KEY: ${{ secrets.VITE_RECAPTCHA_SITE_KEY }}
          VITE_USE_EMULATORS: false

      - name: Verify dist output
        run: |
          test -f dist/index.html || (echo "ERROR: dist/index.html missing" && exit 1)
          echo "Frontend build OK — $(find dist -name '*.js' | wc -l) JS files"

      # Cloud Functions
      - name: Install Cloud Functions dependencies
        run: npm ci
        working-directory: functions

      - name: Build Cloud Functions
        run: npm run build
        working-directory: functions

      - name: Verify functions output
        run: |
          test -f functions/lib/index.js || (echo "ERROR: functions/lib/index.js missing" && exit 1)
          echo "Functions build OK — $(find functions/lib -name '*.js' | wc -l) JS files"

      # Upload build artifacts for deploy job
      - name: Upload frontend artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

      - name: Upload functions artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: functions-lib
          path: functions/lib/
          retention-days: 1
