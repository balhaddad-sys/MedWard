rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isAdminOrClinician() {
      let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return userRole == 'admin' || userRole == 'physician' || userRole == 'clinician';
    }

    // Validate string field length
    function isValidString(field, maxLen) {
      return field is string && field.size() <= maxLen;
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId)
                    && request.resource.data.keys().hasAll(['email', 'displayName', 'role'])
                    && isValidString(request.resource.data.email, 254)
                    && isValidString(request.resource.data.displayName, 100)
                    && request.resource.data.role in ['admin', 'physician', 'clinician', 'nurse'];
      allow update: if isOwner(userId)
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));
    }

    // Patients collection (PHASE 0: Team-based access with flexible permissions)
    match /patients/{patientId} {
      // Read: must be creator OR assigned to the patient (fallback to createdBy if assignedClinicians doesn't exist)
      allow read: if isAuthenticated()
                  && (resource.data.createdBy == request.auth.uid
                      || request.auth.uid in resource.data.get('assignedClinicians', [request.auth.uid]));

      // Create: allow any authenticated user, with basic validation
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && (request.resource.data.acuity is int ?
                        (request.resource.data.acuity >= 1 && request.resource.data.acuity <= 5) : true)
                    && (request.resource.data.state is string ?
                        request.resource.data.state in ['incoming', 'active', 'unstable', 'ready_dc', 'discharged'] : true);

      // Update: must be creator OR assigned to the patient
      allow update: if isAuthenticated()
                    && (resource.data.createdBy == request.auth.uid
                        || (request.auth.uid in resource.data.get('assignedClinicians', [])))
                    && (request.resource.data.acuity is int ?
                        (request.resource.data.acuity >= 1 && request.resource.data.acuity <= 5) : true)
                    && (request.resource.data.state is string ?
                        request.resource.data.state in ['incoming', 'active', 'unstable', 'ready_dc', 'discharged'] : true);

      // Delete: must be original creator
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;

      // Labs subcollection
      match /labs/{labId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.keys().hasAll(['patientId', 'category', 'panelName', 'values', 'status', 'source'])
                      && isValidString(request.resource.data.patientId, 200)
                      && isValidString(request.resource.data.panelName, 200)
                      && request.resource.data.category in ['CBC', 'BMP', 'CMP', 'LFT', 'COAG', 'CARDIAC', 'THYROID', 'UA', 'ABG', 'MISC']
                      && request.resource.data.status in ['pending', 'resulted', 'reviewed']
                      && request.resource.data.source in ['manual', 'ocr', 'hl7', 'image']
                      && request.resource.data.values is list;
        allow update: if isAuthenticated()
                      && request.resource.data.status in ['pending', 'resulted', 'reviewed'];
        allow delete: if isAuthenticated() && get(/databases/$(database)/documents/patients/$(patientId)).data.createdBy == request.auth.uid;
      }

      // History subcollection (patient medical history)
      match /history/{historyId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated()
                      && request.resource.data.keys().hasAll(['patientId', 'updatedBy'])
                      && isValidString(request.resource.data.patientId, 200)
                      && request.resource.data.updatedBy == request.auth.uid;
        allow delete: if isAuthenticated() && get(/databases/$(database)/documents/patients/$(patientId)).data.createdBy == request.auth.uid;
      }

      // Notes subcollection
      match /notes/{noteId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated()
                      && request.resource.data.keys().hasAll(['content'])
                      && isValidString(request.resource.data.content, 10000);
        allow update: if isAuthenticated()
                      && request.resource.data.content is string
                      && request.resource.data.content.size() <= 10000;
        allow delete: if isAuthenticated() && get(/databases/$(database)/documents/patients/$(patientId)).data.createdBy == request.auth.uid;
      }
    }

    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['title', 'priority', 'status'])
                    && isValidString(request.resource.data.title, 500)
                    && request.resource.data.priority in ['critical', 'high', 'medium', 'low']
                    && request.resource.data.status in ['pending', 'in_progress', 'completed', 'cancelled'];
      allow update: if isAuthenticated()
                    && request.resource.data.title is string
                    && request.resource.data.title.size() <= 500
                    && request.resource.data.priority in ['critical', 'high', 'medium', 'low']
                    && request.resource.data.status in ['pending', 'in_progress', 'completed', 'cancelled'];
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // Audit log - append only (immutable records)
    match /auditLog/{logId} {
      allow read: if hasRole('admin');
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['action', 'userId', 'timestamp'])
                    && isValidString(request.resource.data.action, 200)
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // Settings - admin-managed
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if hasRole('admin');
    }

    // Clerking Notes collection
    match /clerking_notes/{noteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['patientId', 'authorId', 'status', 'workingDiagnosis'])
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.status in ['draft', 'signed', 'amended']
                    && isValidString(request.resource.data.workingDiagnosis, 500);
      allow update: if isAuthenticated()
                    && (resource.data.authorId == request.auth.uid || isAdminOrClinician())
                    && request.resource.data.status in ['draft', 'signed', 'amended'];
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
    }

    // On-Call List collection (PHASE 0: Reference-only architecture)
    match /on_call_list/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['patientId', 'priority', 'isActive', 'addedBy'])
                    && isValidString(request.resource.data.patientId, 200)
                    && request.resource.data.priority in ['low', 'medium', 'high', 'critical']
                    && request.resource.data.isActive is bool
                    && request.resource.data.addedBy == request.auth.uid;
      allow update: if isAuthenticated()
                    && request.resource.data.priority in ['low', 'medium', 'high', 'critical']
                    && request.resource.data.isActive is bool;
      allow delete: if isAuthenticated();
    }

    // Notifications collection (PHASE 0.2)
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      // Users can only update their own notifications (e.g., mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }

    // Performance Metrics collection (PHASE 9)
    match /performance_metrics/{metricId} {
      // Only admins can read all metrics
      allow read: if hasRole('admin');
      // Users can create their own metrics
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Metrics are immutable
      allow update, delete: if false;
    }

    // Deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
